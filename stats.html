<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Statistik</title>
  <link rel="stylesheet" href="style.css">

</head>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');

  :root {
    --base-clr: #11121a;
    --line-clr: #42434a;
    --hover-clr: #222533;
    --text-clr: #e6e6ef;
    --accent-clr: #5e63ff;
    --secondary-text-clr: #b0b3c1;
  }

  * {
    margin: 0;
    padding: 0;
  }

  html {
    font-family: Poppins, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.5rem;
  }

  body {
    min-height: 100vh;
    min-height: 100dvh;
    background-color: var(--base-clr);
    color: var(--text-clr);
    display: grid;
    grid-template-columns: auto 1fr;
  }

  #sidebar {
    box-sizing: border-box;
    height: 100vh;
    width: 250px;
    padding: 5px 1em;
    background-color: var(--base-clr);
    border-right: 1px solid var(--line-clr);

    position: sticky;
    top: 0;
    align-self: start;
    transition: 300ms ease-in-out;
    overflow: hidden;
    text-wrap: nowrap;
  }

  #sidebar.close {
    padding: 5px;
    width: 60px;
  }

  #sidebar ul {
    list-style: none;
  }

  #sidebar>ul>li:first-child {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 16px;

    .logo {
      font-weight: 600;
    }
  }

  #sidebar ul li.active a {
    color: var(--accent-clr);

    svg {
      fill: var(--accent-clr);
    }
  }

  #sidebar a,
  #sidebar .dropdown-btn,
  #sidebar .logo {
    border-radius: .5em;
    padding: .85em;
    text-decoration: none;
    color: var(--text-clr);
    display: flex;
    align-items: center;
    gap: 1em;
  }

  .dropdown-btn {
    width: 100%;
    text-align: left;
    background: none;
    border: none;
    font: inherit;
    cursor: pointer;
  }

  #sidebar svg {
    flex-shrink: 0;
    fill: var(--text-clr);
  }

  #sidebar a span,
  #sidebar .dropdown-btn span {
    flex-grow: 1;
  }

  #sidebar a:hover,
  #sidebar .dropdown-btn:hover {
    background-color: var(--hover-clr);
  }

  #sidebar .sub-menu {
    display: grid;
    grid-template-rows: 0fr;
    transition: 300ms ease-in-out;

    >div {
      overflow: hidden;
    }
  }

  #sidebar .sub-menu.show {
    grid-template-rows: 1fr;
  }

  .dropdown-btn svg {
    transition: 200ms ease;
  }

  .rotate svg:last-child {
    rotate: 180deg;
  }

  #sidebar .sub-menu a {
    padding-left: 2em;
  }

  #toggle-btn {
    margin-left: auto;
    padding: 1em;
    border: none;
    border-radius: .5em;
    background: none;
    cursor: pointer;

    svg {
      transition: rotate 150ms ease;
    }
  }

  #toggle-btn:hover {
    background-color: var(--hover-clr);
  }

  main {
    padding: min(30px, 7%);
  }

  main p {
    color: var(--secondary-text-clr);
    margin-top: 5px;
    margin-bottom: 15px;
  }

  .container {
    border: 1px solid var(--line-clr);
    border-radius: 1em;
    margin-bottom: 20px;
    padding: min(3em, 15%);

    h2,
    p {
      margin-top: 1em
    }
  }

  @media(max-width: 800px) {
    body {
      grid-template-columns: 1fr;
    }

    main {
      padding: 2em 1em 60px 1em;
    }

    .container {
      border: none;
      padding: 0;
    }

    #sidebar {
      height: 60px;
      width: 100%;
      border-right: none;
      border-top: 1px solid var(--line-clr);
      padding: 0;
      position: fixed;
      top: unset;
      bottom: 0;

      >ul {
        padding: 0;
        display: grid;
        grid-auto-columns: 60px;
        grid-auto-flow: column;
        align-items: center;
        overflow-x: scroll;
      }

      ul li {
        height: 100%;
      }

      ul a,
      ul .dropdown-btn {
        width: 60px;
        height: 60px;
        padding: 0;
        border-radius: 0;
        justify-content: center;
      }

      ul li span,
      ul li:first-child,
      .dropdown-btn svg:last-child {
        display: none;
      }

      ul li .sub-menu.show {
        position: fixed;
        bottom: 60px;
        left: 0;
        box-sizing: border-box;
        height: 60px;
        width: 100%;
        background-color: var(--hover-clr);
        border-top: 1px solid var(--line-clr);
        display: flex;
        justify-content: center;

        >div {
          overflow-x: auto;
        }

        li {
          display: inline-flex;
        }

        a {
          box-sizing: border-box;
          padding: 1em;
          width: auto;
          justify-content: center;
        }
      }
    }
  }
</style>

<body>
  <nav id="sidebar">
    <ul>
      <li>
        <span class="logo">Menu</span>
        <button onclick="toggleSidebar()" id="toggle-btn">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed">
            <path
              d="m313-480 155 156q11 11 11.5 27.5T468-268q-11 11-28 11t-28-11L228-452q-6-6-8.5-13t-2.5-15q0-8 2.5-15t8.5-13l184-184q11-11 27.5-11.5T468-692q11 11 11 28t-11 28L313-480Zm264 0 155 156q11 11 11.5 27.5T732-268q-11 11-28 11t-28-11L492-452q-6-6-8.5-13t-2.5-15q0-8 2.5-15t8.5-13l184-184q11-11 27.5-11.5T732-692q11 11 11 28t-11 28L577-480Z">
            </path>
          </svg>
        </button>
      </li>
      <li>
        <a href="index.html">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed">
            <path
              d="M520-640v-160q0-17 11.5-28.5T560-840h240q17 0 28.5 11.5T840-800v160q0 17-11.5 28.5T800-600H560q-17 0-28.5-11.5T520-640ZM120-480v-320q0-17 11.5-28.5T160-840h240q17 0 28.5 11.5T440-800v320q0 17-11.5 28.5T400-440H160q-17 0-28.5-11.5T120-480Zm400 320v-320q0-17 11.5-28.5T560-520h240q17 0 28.5 11.5T840-480v320q0 17-11.5 28.5T800-120H560q-17 0-28.5-11.5T520-160Zm-400 0v-160q0-17 11.5-28.5T160-360h240q17 0 28.5 11.5T440-320v160q0 17-11.5 28.5T400-120H160q-17 0-28.5-11.5T120-160Zm80-360h160v-240H200v240Zm400 320h160v-240H600v240Zm0-480h160v-80H600v80ZM200-200h160v-80H200v80Zm160-320Zm240-160Zm0 240ZM360-280Z">
            </path>
          </svg>
          <span>Dashboard</span>
        </a>
      </li>
      <li>
        <button onclick="toggleSubMenu(this)" class="dropdown-btn">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000">
            <path
              d="M160-200h160v-320H160v320Zm240 0h160v-560H400v560Zm240 0h160v-240H640v240ZM80-120v-480h240v-240h320v320h240v400H80Z" />
          </svg>
          <span>Stats</span>
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed">
            <path
              d="M480-361q-8 0-15-2.5t-13-8.5L268-556q-11-11-11-28t11-28q11-11 28-11t28 11l156 156 156-156q11-11 28-11t28 11q11 11 11 28t-11 28L508-372q-6 6-13 8.5t-15 2.5Z">
            </path>
          </svg>
        </button>
        <ul class="sub-menu">
          <div>
            <li><a href="stats.html" data-view-link="dashboard">Dashboard</a></li>
            <li><a href="stats.html" data-view-link="exams">Prüfungen</a></li>
            <li><a href="stats.html" data-view-link="data">Daten</a></li>
          </div>
        </ul>
      </li>
      <li>
        <a href="calendar.html">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000">
            <path
              d="M200-80q-33 0-56.5-23.5T120-160v-560q0-33 23.5-56.5T200-800h40v-80h80v80h320v-80h80v80h40q33 0 56.5 23.5T840-720v560q0 33-23.5 56.5T760-80H200Zm0-80h560v-400H200v400Zm0-480h560v-80H200v80Zm0 0v-80 80Zm280 240q-17 0-28.5-11.5T440-440q0-17 11.5-28.5T480-480q17 0 28.5 11.5T520-440q0 17-11.5 28.5T480-400Zm-160 0q-17 0-28.5-11.5T280-440q0-17 11.5-28.5T320-480q17 0 28.5 11.5T360-440q0 17-11.5 28.5T320-400Zm320 0q-17 0-28.5-11.5T600-440q0-17 11.5-28.5T640-480q17 0 28.5 11.5T680-440q0 17-11.5 28.5T640-400ZM480-240q-17 0-28.5-11.5T440-280q0-17 11.5-28.5T480-320q17 0 28.5 11.5T520-280q0 17-11.5 28.5T480-240Zm-160 0q-17 0-28.5-11.5T280-280q0-17 11.5-28.5T320-320q17 0 28.5 11.5T360-280q0 17-11.5 28.5T320-240Zm320 0q-17 0-28.5-11.5T600-280q0-17 11.5-28.5T640-320q17 0 28.5 11.5T680-280q0 17-11.5 28.5T640-240Z" />
          </svg>
          <span>Kalender</span>
        </a>
      </li>
      <li>
        <a href="settings.html">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000">
            <path
              d="m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Zm70-80h79l14-106q31-8 57.5-23.5T639-327l99 41 39-68-86-65q5-14 7-29.5t2-31.5q0-16-2-31.5t-7-29.5l86-65-39-68-99 42q-22-23-48.5-38.5T533-694l-13-106h-79l-14 106q-31 8-57.5 23.5T321-633l-99-41-39 68 86 64q-5 15-7 30t-2 32q0 16 2 31t7 30l-86 65 39 68 99-42q22 23 48.5 38.5T427-266l13 106Zm42-180q58 0 99-41t41-99q0-58-41-99t-99-41q-59 0-99.5 41T342-480q0 58 40.5 99t99.5 41Zm-2-140Z" />
          </svg>
          <span>Einstellungen</span>
        </a>
      </li>
    </ul>
  </nav>
  <main class="content">
    <!-- white inner box with border so elements are not directly at the screen edge -->
    <div class="stats-inner">

      <header>
        <h1>Statistiken — Erweiterte Ansicht</h1>
        <div class="controls">
          <button id="refresh" class="btn">↻ Aktualisieren</button>
        </div>
      </header>

      <!-- views: dashboard, exams, data -->
      <section id="view-dashboard" class="view active">
        <!-- Top overview -->
        <section class="grid" id="overview">
          <div class="card">
            <div class="muted">Anzahl Fächer</div>
            <div id="totalSubjects" class="big">–</div>
          </div>
          <div class="card">
            <div class="muted">Anzahl Prüfungen</div>
            <div id="totalExams" class="big">–</div>
          </div>
          <div class="card">
            <div class="muted">Ungenügende (&lt; 4.0)</div>
            <div id="insufficient" class="big">–</div>
          </div>
          <div class="card">
            <div class="muted">Gesamt Ø (Fach-Mittel)</div>
            <div id="overallAvg" class="big">–</div>
          </div>
        </section>

        <!-- extended stats -->
        <section style="margin-top:14px" class="grid">
          <div class="card">
            <div class="muted">Statistik (Notenbasis)</div>
            <div style="margin-top:8px">
              <div class="small">Median</div>
              <div id="median" class="big">-</div>
              <div class="small">Standardabweichung</div>
              <div id="stddev" class="big">-</div>
              <div class="small">Bestehensrate (≥ 4.0)</div>
              <div id="passRate" class="big">-</div>
            </div>
          </div>

          <div class="card">
            <div class="muted">Kern- / Erweiterungs-Durchschnitte</div>
            <div style="margin-top:8px">
              <div class="small">Kernfächer Ø</div>
              <div id="coreAvg" class="big">-</div>
              <div class="small">Erweiterungen Ø</div>
              <div id="extAvg" class="big">-</div>
              <div class="small">Unterschied (Kern − Erw.)</div>
              <div id="diffCoreExt" class="big">-</div>
            </div>
          </div>

          <div class="card">
            <div class="muted">Trend & Zeit</div>
            <div style="margin-top:8px">
              <div class="small">Durchschnitt (letzte 30 Tage)</div>
              <div id="avg30" class="big">-</div>
              <div class="small">Durchschnitt (letzte 7 Tage)</div>
              <div id="avg7" class="big">-</div>
              <div class="small">Anzahl Prüfungen in letzten 30 Tagen</div>
              <div id="count30" class="big">-</div>
            </div>
          </div>

          <div class="card">
            <div class="muted">Upcoming / Fällige Prüfungen</div>
            <div id="upcoming" style="margin-top:8px">-</div>
          </div>
        </section>

        <!-- detailed lists -->
        <section style="margin-top:14px" class="grid">
          <div class="card">
            <div class="muted">Fächer — Notendurchschnitte & Varianz</div>
            <div id="subjectList" class="list" style="margin-top:10px">–</div>
          </div>

          <div class="card">
            <div class="muted">Schlechteste Prüfungen</div>
            <div id="worstList" style="margin-top:8px">–</div>
          </div>

          <div class="card">
            <div class="muted">Beste Prüfungen</div>
            <div id="bestList" style="margin-top:8px">–</div>
          </div>

          <div class="card">
            <div class="muted">Verteilung (Noten 1.0–6.0)</div>
            <div id="distribution" style="margin-top:8px">–</div>
          </div>
        </section>
      </section>

      <section id="view-exams" class="view">
        <div class="card">
          <div class="muted">Alle Prüfungen</div>
          <div id="allExams" style="margin-top:10px">-</div>
        </div>
      </section>

      <section id="view-data" class="view">
        <div class="card">
          <div class="muted">Rohdaten (JSON)</div>
          <textarea id="rawData"
            style="width:100%;height:200px;margin-top:8px;padding:8px;border-radius:8px;border:1px solid #e6eaee;background:#fafbfd"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="downloadData" class="btn">Download JSON</button>
            <button id="copyData" class="btn">In Zwischenablage kopieren</button>
          </div>
        </div>
      </section>

      <!-- <footer style="margin-top:18px;font-size:13px;color:var(--muted)">Diese Seite liest die lokal gespeicherten Daten (localStorage – key: <code>subjects_v3</code>). Sie aktualisiert automatisch bei Änderungen.</footer> -->

    </div> <!-- .stats-inner -->
  </main>

</body>
<script>
  const toggleButton = document.getElementById('toggle-btn')
  const sidebar = document.getElementById('sidebar')

  function toggleSidebar() {
    sidebar.classList.toggle('close')
    toggleButton.classList.toggle('rotate')

    closeAllSubMenus()
  }

  function toggleSubMenu(button) {

    if (!button.nextElementSibling.classList.contains('show')) {
      closeAllSubMenus()
    }

    button.nextElementSibling.classList.toggle('show')
    button.classList.toggle('rotate')

    if (sidebar.classList.contains('close')) {
      sidebar.classList.toggle('close')
      toggleButton.classList.toggle('rotate')
    }
  }

  function closeAllSubMenus() {
    Array.from(sidebar.getElementsByClassName('show')).forEach(ul => {
      ul.classList.remove('show')
      ul.previousElementSibling.classList.remove('rotate')
    })
  }

  /* Main Script */

  (function () {
    const KEY = 'subjects_v3';
    const refreshBtn = document.getElementById('refresh');
    const statsToggle = document.getElementById('statsToggle');
    const statsSubmenu = document.getElementById('statsSubmenu');
    const viewLinks = document.querySelectorAll('[data-view-link]');
    let lastRaw = null;

    // simple view switcher
    function switchView(name) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); const el = document.getElementById('view-' + name); if (el) el.classList.add('active'); }
    viewLinks.forEach(a => { a.addEventListener('click', (e) => { e.preventDefault(); const v = a.dataset.viewLink; switchView(v); }); });

    if (statsToggle && statsSubmenu) {
      statsToggle.addEventListener('click', () => { const open = statsSubmenu.style.display !== 'flex'; statsSubmenu.style.display = open ? 'flex' : 'none'; statsSubmenu.setAttribute('aria-hidden', !open); });
    }

    function load() { try { const raw = localStorage.getItem(KEY); lastRaw = raw; return raw ? JSON.parse(raw) : []; } catch (e) { console.error(e); return []; } }

    function computeSubjectAvg(subject) { if (!subject.exams || subject.exams.length === 0) return null; let sum = 0, weightSum = 0; subject.exams.forEach(ex => { const g = parseFloat(ex.grade); if (!isNaN(g)) { const mult = parseFloat(ex.multiplier) || 1; sum += g * mult; weightSum += mult; } }); if (weightSum === 0) return null; let avg = sum / weightSum; return Math.round(avg * 10) / 10; }
    function median(values) { if (!values.length) return null; values = values.slice().sort((a, b) => a - b); const half = Math.floor(values.length / 2); if (values.length % 2) return values[half]; return Math.round(((values[half - 1] + values[half]) / 2) * 10) / 10; }
    function stddev(values) { if (!values.length) return null; const m = values.reduce((a, b) => a + b, 0) / values.length; const variance = values.reduce((a, b) => a + Math.pow(b - m, 2), 0) / values.length; return Math.round(Math.sqrt(variance) * 100) / 100; }

    function render() {
      const subjects = load(); const totalSubjects = subjects.length; let totalExams = 0; let insufficient = 0; let sumAvg = 0, countAvg = 0; const subjectStats = []; const allGrades = [];

      const now = new Date(); const msDay = 24 * 60 * 60 * 1000;
      const last30 = new Date(now - 30 * msDay);
      const last7 = new Date(now - 7 * msDay);
      let sum30 = 0, count30 = 0, sum7 = 0, count7 = 0;
      const upcoming = [];

      subjects.forEach(s => {
        const exams = s.exams || [];
        totalExams += exams.length;
        let subIns = 0; let gradesForSub = [];
        exams.forEach(ex => {
          const g = parseFloat(ex.grade);

          // collect grades if present
          if (!isNaN(g)) {
            allGrades.push(g);
            gradesForSub.push(g);
          }

          // time based calculations (IMPORTANT): include upcoming / due regardless of grade
          if (ex.date) {
            const d = new Date(ex.date + 'T00:00:00'); if (!isNaN(d)) {
              // for averages over time only include exams that have a numeric grade
              if (!isNaN(g)) {
                if (d >= last30) { sum30 += g; count30++; }
                if (d >= last7) { sum7 += g; count7++; }
              }
              // upcoming = future exams (regardless of grade)
              if (d > now) { upcoming.push({ subject: s.name, name: ex.name, date: ex.date, grade: isNaN(g) ? null : g }); }
            }
          }

          // count insufficient even if grade exists
          if (!isNaN(g) && g < 4.0) { insufficient++; subIns++; }
        });
        const subAvg = computeSubjectAvg(s);
        const variance = gradesForSub.length ? Math.round((gradesForSub.reduce((a, b) => a + Math.pow(b - (gradesForSub.reduce((x, y) => x + y, 0) / gradesForSub.length), 2), 0) / gradesForSub.length) * 100) / 100 : null;
        if (subAvg !== null) { sumAvg += subAvg; countAvg++; }
        subjectStats.push({ id: s.id, name: s.name, avg: subAvg || null, insufficient: subIns, examCount: exams.length, variance: variance });
      });

      const overallAvg = countAvg === 0 ? null : Math.round((sumAvg / countAvg) * 10) / 10;
      const med = median(allGrades);
      const sd = stddev(allGrades);
      const passRate = allGrades.length ? Math.round((allGrades.filter(g => g >= 4).length / allGrades.length) * 100) : 0;
      const coreAvg = (() => { const core = subjects.filter(s => s.type === 'core'); const a = core.map(s => computeSubjectAvg(s)).filter(x => x !== null); return a.length ? Math.round((a.reduce((x, y) => x + y, 0) / a.length) * 10) / 10 : null; })();
      const extAvg = (() => { const ext = subjects.filter(s => s.type === 'extension'); const a = ext.map(s => computeSubjectAvg(s)).filter(x => x !== null); return a.length ? Math.round((a.reduce((x, y) => x + y, 0) / a.length) * 10) / 10 : null; })();

      const avg30 = count30 ? Math.round((sum30 / count30) * 10) / 10 : null;
      const avg7 = count7 ? Math.round((sum7 / count7) * 10) / 10 : null;

      // dashboard updates
      document.getElementById('totalSubjects').textContent = totalSubjects;
      document.getElementById('totalExams').textContent = totalExams;
      document.getElementById('insufficient').textContent = insufficient;
      document.getElementById('overallAvg').textContent = overallAvg === null ? '-' : overallAvg;

      document.getElementById('median').textContent = med === null ? '-' : med;
      document.getElementById('stddev').textContent = sd === null ? '-' : sd;
      document.getElementById('passRate').textContent = allGrades.length ? passRate + ' %' : '-';

      document.getElementById('coreAvg').textContent = coreAvg === null ? '-' : coreAvg;
      document.getElementById('extAvg').textContent = extAvg === null ? '-' : extAvg;
      const diff = (coreAvg !== null && extAvg !== null) ? Math.round((coreAvg - extAvg) * 10) / 10 : '-';
      document.getElementById('diffCoreExt').textContent = diff;

      document.getElementById('avg30').textContent = avg30 === null ? '-' : avg30;
      document.getElementById('avg7').textContent = avg7 === null ? '-' : avg7;
      document.getElementById('count30').textContent = count30;

      // upcoming: sort by date (shows future exams, includes those without grade)
      const upEl = document.getElementById('upcoming'); upEl.innerHTML = '';
      upcoming.sort((a, b) => new Date(a.date) - new Date(b.date));
      if (upcoming.length === 0) upEl.textContent = 'Keine anstehenden Prüfungen'; else upcoming.slice(0, 8).forEach(u => { const d = document.createElement('div'); d.innerHTML = `<strong>${escapeHtml(u.name)}</strong> <div class="small">${escapeHtml(u.subject)} • ${u.date} • ${u.grade === null ? '<em class="small">(ohne Note)</em>' : '<span class="note-pill ' + (u.grade < 4 ? 'low' : '') + '">' + u.grade + '</span>'}</div>`; upEl.appendChild(d); });

      // subjects list sorted by avg desc and show variance
      const subjectList = document.getElementById('subjectList'); subjectList.innerHTML = '';
      subjectStats.sort((a, b) => (b.avg || 0) - (a.avg || 0));
      subjectStats.forEach(s => {
        const row = document.createElement('div'); row.style.display = 'flex'; row.style.justifyContent = 'space-between'; row.style.alignItems = 'center';
        const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:800">${escapeHtml(s.name)}</div><div class="small">${s.examCount} Prüfungen • ${s.insufficient} ungenügend</div>`;
        const right = document.createElement('div'); right.style.textAlign = 'right'; right.style.minWidth = '110px';
        const avgText = s.avg === null ? '<span class="small">-</span>' : `<span class="note-pill ${s.avg < 4 ? 'low' : ''}">${s.avg}</span>`;
        const varText = s.variance === null ? '<span class="small">-</span>' : `<div class="spark">σ²=${s.variance}</div>`;
        right.innerHTML = avgText + varText;
        row.appendChild(left); row.appendChild(right); subjectList.appendChild(row);
      });

      // best/worst lists
      const allEx = [];
      subjects.forEach(s => { (s.exams || []).forEach(ex => { const g = parseFloat(ex.grade); allEx.push({ subject: s.name, name: ex.name, grade: isNaN(g) ? null : g, date: ex.date || '' }); }); });
      const validEx = allEx.filter(e => e.grade !== null);
      validEx.sort((a, b) => a.grade - b.grade);
      const worstList = document.getElementById('worstList'); worstList.innerHTML = '';
      validEx.slice(0, 8).forEach(e => { const div = document.createElement('div'); div.innerHTML = `<strong>${escapeHtml(e.name)}</strong> <div class="small">${escapeHtml(e.subject)} • ${e.date || '-'} • <span class="note-pill ${e.grade < 4 ? 'low' : ''}">${e.grade}</span></div>`; worstList.appendChild(div); });
      const bestList = document.getElementById('bestList'); bestList.innerHTML = '';
      validEx.slice(-8).reverse().forEach(e => { const div = document.createElement('div'); div.innerHTML = `<strong>${escapeHtml(e.name)}</strong> <div class="small">${escapeHtml(e.subject)} • ${e.date || '-'} • <span class="note-pill ${e.grade < 4 ? 'low' : ''}">${e.grade}</span></div>`; bestList.appendChild(div); });

      // distribution (1.0–6.0 by 0.25 buckets for more detail)
      const distribution = document.getElementById('distribution'); distribution.innerHTML = '';
      const buckets = {};
      for (let g = 1.0; g <= 6.0; g += 0.25) { buckets[g.toFixed(2)] = 0; }
      validEx.forEach(e => {
        const rounded = Math.round(e.grade * 4) / 4; const key = rounded.toFixed(2);
        if (buckets[key] !== undefined) buckets[key]++;
      });
      const maxCount = Math.max(...Object.values(buckets), 1);
      Object.keys(buckets).sort((a, b) => parseFloat(a) - parseFloat(b)).forEach(k => {
        if (buckets[k] === 0) return; // skip empty buckets
        const row = document.createElement('div'); row.style.display = 'flex'; row.style.alignItems = 'center'; row.style.gap = '8px';
        const label = document.createElement('div'); label.style.width = '48px'; label.textContent = parseFloat(k).toFixed(2);
        const prog = document.createElement('div'); prog.className = 'progress'; prog.style.flex = '1'; const inner = document.createElement('div'); inner.className = 'bar'; inner.style.width = (buckets[k] / maxCount * 100) + '%'; prog.appendChild(inner);
        const count = document.createElement('div'); count.style.width = '36px'; count.style.textAlign = 'right'; count.textContent = buckets[k]; row.appendChild(label); row.appendChild(prog); row.appendChild(count); distribution.appendChild(row);
      });

      // render all exams view (include exams even without grade)
      const allExamsEl = document.getElementById('allExams'); allExamsEl.innerHTML = '';
      allEx.sort((a, b) => (a.date || '').localeCompare(b.date || ''));
      allEx.forEach(e => { const d = document.createElement('div'); d.style.padding = '8px 0'; d.innerHTML = `<strong>${escapeHtml(e.name)}</strong> <div class="small">${escapeHtml(e.subject)} • ${e.date || '-'} • ${e.grade === null ? '<em>(ohne Note)</em>' : '<span class="note-pill ' + (e.grade < 4 ? 'low' : '') + '">' + e.grade + '</span>'}</div>`; allExamsEl.appendChild(d); });

      // fill raw data textarea
      const rawTa = document.getElementById('rawData'); try { rawTa.value = JSON.stringify({ subjects, generatedAt: new Date().toISOString() }, null, 2); } catch (e) { rawTa.value = 'Fehler beim Erstellen der Rohdaten'; }

    }

    function escapeHtml(str) { return ('' + str).replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }

    // download / copy handlers for data view
    document.getElementById('downloadData').addEventListener('click', () => {
      const ta = document.getElementById('rawData'); const blob = new Blob([ta.value], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'subjects_export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    document.getElementById('copyData').addEventListener('click', async () => { try { await navigator.clipboard.writeText(document.getElementById('rawData').value); alert('Kopiert'); } catch (e) { alert('Kopieren nicht möglich'); } });

    // auto-refresh when localStorage changes in other tabs
    window.addEventListener('storage', (e) => { if (e.key === KEY) { render(); } });
    // polling fallback
    setInterval(() => { const raw = localStorage.getItem(KEY); if (raw !== lastRaw) { lastRaw = raw; render(); } }, 1500);
    refreshBtn.addEventListener('click', () => render());

    // initial render
    render();

  })();
</script>

</html>