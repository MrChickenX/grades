<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <script src="theme.js" defer></script>
</head>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');

  html {
    font-family: Poppins, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.5rem;
  }

  body {
    min-height: 100vh;
    min-height: 100dvh;
    background-color: var(--sidebar-bg);
    color: var(--sb-fontcolor);
    display: grid;
    grid-template-columns: auto 1fr;
  }

  #sidebar {
    box-sizing: border-box;
    height: 100vh;
    width: 250px;
    padding: 5px 1em;
    background-color: var(--sidebar-bg);
    border-right: 1px solid var(--border);

    position: sticky;
    top: 0;
    align-self: start;
    transition: 300ms ease-in-out;
    overflow: hidden;
    text-wrap: nowrap;
  }

  #sidebar.close {
    padding: 5px;
    width: 60px;
  }

  #sidebar ul {
    list-style: none;
  }

  #sidebar>ul>li:first-child {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 16px;

    .logo {
      font-weight: 600;
    }
  }

  #sidebar ul li.active a {
    /* active sidebar link */
    color: var(--accent) !important;
  }

  #sidebar ul li.active a span {
    color: var(--accent) !important;
  }

  #sidebar ul li.active a svg {
    fill: var(--accent) !important;
  }

  #sidebar a,
  #sidebar .dropdown-btn,
  #sidebar .logo {
    border-radius: .5em;
    padding: .85em;
    text-decoration: none;
    color: var(--sb-fontcolor);
    display: flex;
    align-items: center;
    gap: 1em;
  }

  .dropdown-btn {
    width: 100%;
    text-align: left;
    background: none;
    border: none;
    font: inherit;
    cursor: pointer;
  }

  #sidebar svg {
    flex-shrink: 0;
    fill: var(--sb-fontcolor);
  }

  #sidebar a span,
  #sidebar .dropdown-btn span {
    flex-grow: 1;
  }

  #sidebar a,
  #sidebar .dropdown-btn,
  #sidebar span {
    color: var(--sb-fontcolor);
  }

  #sidebar a:hover,
  #sidebar .dropdown-btn:hover {
    background-color: var(--glass);
  }

  #sidebar .sub-menu {
    display: grid;
    grid-template-rows: 0fr;
    transition: 300ms ease-in-out;

    >div {
      overflow: hidden;
    }
  }

  #sidebar .sub-menu.show {
    grid-template-rows: 1fr;
  }

  .dropdown-btn svg {
    transition: 200ms ease;
  }

  .rotate svg:last-child {
    rotate: 180deg;
  }

  #sidebar .sub-menu a {
    padding-left: 2em;
  }

  #toggle-btn {
    margin-left: auto;
    padding: 1em;
    border: none;
    border-radius: .5em;
    background: none;
    cursor: pointer;

    svg {
      transition: rotate 150ms ease;
    }
  }

  #toggle-btn:hover {
    background-color: var(--glass);
  }

  main {
    padding: min(30px, 7%);
  }

  main p {
    color: var(--sb-fontcolor);
    margin-top: 5px;
    margin-bottom: 15px;
  }

  .container {
    border: 1px solid var(--border);
    border-radius: 1em;
    margin-bottom: 20px;
    padding: min(3em, 15%);

    h2,
    p {
      margin-top: 1em
    }
  }

  /* --- WARN-BOX styling --- */
  .warn-box {
    margin-top: 10px;
    padding: 10px 12px;
    border-radius: 8px;
    background: rgba(255, 165, 0, 0.12);
    border: 1px solid rgba(255, 165, 0, 0.28);
    color: #ffd98a;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    font-size: 13px;
  }

  .warn-box .warn-text {
    flex: 1;
  }

  .warn-close {
    background: transparent;
    border: none;
    color: #ffd98a;
    font-weight: 700;
    cursor: pointer;
    padding: 4px 6px;
    border-radius: 6px;
    line-height: 1;
  }

  .warn-close:hover {
    background: rgba(255, 165, 0, 0.18);
  }

  @media(max-width: 800px) {
    body {
      grid-template-columns: 1fr;
    }

    main {
      padding: 2em 1em 60px 1em;
    }

    .container {
      border: none;
      padding: 0;
    }

    #sidebar {
      height: 60px;
      width: 100%;
      border-right: none;
      border-top: 1px solid var(--border);
      padding: 0;
      position: fixed;
      top: unset;
      bottom: 0;

      >ul {
        padding: 0;
        display: grid;
        grid-auto-columns: 60px;
        grid-auto-flow: column;
        align-items: center;
        overflow-x: scroll;
      }

      ul li {
        height: 100%;
      }

      ul a,
      ul .dropdown-btn {
        width: 60px;
        height: 60px;
        padding: 0;
        border-radius: 0;
        justify-content: center;
      }

      ul li span,
      ul li:first-child,
      .dropdown-btn svg:last-child {
        display: none;
      }

      ul li .sub-menu.show {
        position: fixed;
        bottom: 60px;
        left: 0;
        box-sizing: border-box;
        height: 60px;
        width: 100%;
        background-color: var(--glass);
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: center;

        >div {
          overflow-x: auto;
        }

        li {
          display: inline-flex;
        }

        a {
          box-sizing: border-box;
          padding: 1em;
          width: auto;
          justify-content: center;
        }
      }
    }
  }
</style>

<body>
  <nav id="sidebar">
    <ul>
      <li>
        <span class="logo">Menu</span>
        <button onclick="toggleSidebar()" id="toggle-btn">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed">
            <path
              d="m313-480 155 156q11 11 11.5 27.5T468-268q-11 11-28 11t-28-11L228-452q-6-6-8.5-13t-2.5-15q0-8 2.5-15t8.5-13l184-184q11-11 27.5-11.5T468-692q11 11 11 28t-11 28L313-480Zm264 0 155 156q11 11 11.5 27.5T732-268q-11 11-28 11t-28-11L492-452q-6-6-8.5-13t-2.5-15q0-8 2.5-15t8.5-13l184-184q11-11 27.5-11.5T732-692q11 11 11 28t-11 28L577-480Z">
            </path>
          </svg>
        </button>
      </li>
      <li class="active">
        <a href="index.html">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed">
            <path
              d="M520-640v-160q0-17 11.5-28.5T560-840h240q17 0 28.5 11.5T840-800v160q0 17-11.5 28.5T800-600H560q-17 0-28.5-11.5T520-640ZM120-480v-320q0-17 11.5-28.5T160-840h240q17 0 28.5 11.5T440-800v320q0 17-11.5 28.5T400-440H160q-17 0-28.5-11.5T120-480Zm400 320v-320q0-17 11.5-28.5T560-520h240q17 0 28.5 11.5T840-480v320q0 17-11.5 28.5T800-120H560q-17 0-28.5-11.5T520-160Zm-400 0v-160q0-17 11.5-28.5T160-360h240q17 0 28.5 11.5T440-320v160q0 17-11.5 28.5T400-120H160q-17 0-28.5-11.5T120-160Zm80-360h160v-240H200v240Zm400 320h160v-240H600v240Zm0-480h160v-80H600v80ZM200-200h160v-80H200v80Zm160-320Zm240-160Zm0 240ZM360-280Z">
            </path>
          </svg>
          <span>Dashboard</span>
        </a>
      </li>
      <li>
        <button onclick="toggleSubMenu(this)" class="dropdown-btn">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000">
            <path
              d="M160-200h160v-320H160v320Zm240 0h160v-560H400v560Zm240 0h160v-240H640v240ZM80-120v-480h240v-240h320v320h240v400H80Z" />
          </svg>
          <span>Stats</span>
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed">
            <path
              d="M480-361q-8 0-15-2.5t-13-8.5L268-556q-11-11-11-28t11-28q11-11 28-11t28 11l156 156 156-156q11-11 28-11t28 11q11 11 11 28t-11 28L508-372q-6 6-13 8.5t-15 2.5Z">
            </path>
          </svg>
        </button>
        <ul class="sub-menu">
          <div>
            <li><a href="stats.html" data-view-link="dashboard">Dashboard</a></li>
            <li><a href="stats.html" data-view-link="exams">PrÃ¼fungen</a></li>
            <li><a href="stats.html" data-view-link="data">Daten</a></li>
          </div>
        </ul>
      </li>
      <li>
        <a href="calendar.html">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000">
            <path
              d="M200-80q-33 0-56.5-23.5T120-160v-560q0-33 23.5-56.5T200-800h40v-80h80v80h320v-80h80v80h40q33 0 56.5 23.5T840-720v560q0 33-23.5 56.5T760-80H200Zm0-80h560v-400H200v400Zm0-480h560v-80H200v80Zm0 0v-80 80Zm280 240q-17 0-28.5-11.5T440-440q0-17 11.5-28.5T480-480q17 0 28.5 11.5T520-440q0 17-11.5 28.5T480-400Zm-160 0q-17 0-28.5-11.5T280-440q0-17 11.5-28.5T320-480q17 0 28.5 11.5T360-440q0 17-11.5 28.5T320-400Zm320 0q-17 0-28.5-11.5T600-440q0-17 11.5-28.5T640-480q17 0 28.5 11.5T680-440q0 17-11.5 28.5T640-400ZM480-240q-17 0-28.5-11.5T440-280q0-17 11.5-28.5T480-320q17 0 28.5 11.5T520-280q0 17-11.5 28.5T480-240Zm-160 0q-17 0-28.5-11.5T280-280q0-17 11.5-28.5T320-320q17 0 28.5 11.5T360-280q0 17-11.5 28.5T320-240Zm320 0q-17 0-28.5-11.5T600-280q0-17 11.5-28.5T640-320q17 0 28.5 11.5T680-280q0 17-11.5 28.5T640-240Z" />
          </svg>
          <span>Kalender</span>
        </a>
      </li>
      <li>
        <a href="settings.html">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000">
            <path
              d="m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Zm70-80h79l14-106q31-8 57.5-23.5T639-327l99 41 39-68-86-65q5-14 7-29.5t2-31.5q0-16-2-31.5t-7-29.5l86-65-39-68-99 42q-22-23-48.5-38.5T533-694l-13-106h-79l-14 106q-31 8-57.5 23.5T321-633l-99-41-39 68 86 64q-5 15-7 30t-2 32q0 16 2 31t7 30l-86 65 39 68 99-42q22 23 48.5 38.5T427-266l13 106Zm42-180q58 0 99-41t41-99q0-58-41-99t-99-41q-59 0-99.5 41T342-480q0 58 40.5 99t99.5 41Zm-2-140Z" />
          </svg>
          <span>Einstellungen</span>
        </a>
      </li>
    </ul>
  </nav>
  <main class="content" id="main">
    <header>
      <div class="title">Dashboard</div>
      <!-- Global menu removed -->
      </div>
    </header>

    <div class="topbar">
      <div class="add-subject">
        <button id="openAdd" class="btn">ï¼‹ Fach</button>
        <div id="inlineAdd" style="display:none;align-items:center">
          <input id="newSubjectName" placeholder="Name vom Fach (z.B. Mathe)" />
          <button id="addSubjectBtn" class="btn accent" style="margin-left: 4px;">HinzufÃ¼gen</button>
          <button id="cancelAdd" class="btn" style="margin-left: 4px;">Abbrechen</button>
        </div>
      </div>

      <!-- export / import / save to disk -->
      <div style="display:flex;gap:8px;align-items:center">
        <button id="exportBtn" class="btn">ðŸ“¤ Exportieren</button>
        <button id="importBtn" class="btn">ðŸ“¥ Importieren</button>
        <button id="saveDiskBtn" class="btn">ðŸ’¾ In Datei speichern (FS)</button>
        <input id="fileInput" type="file" accept="application/json" style="display:none" />
      </div>

      <div style="margin-left:auto;text-align:right;display:flex;gap:10px;align-items:center">
        <div class="summary-box">
          <div class="summary-item">
            <div class="label">Gesamt Ã˜</div>
            <div id="totalAvg" class="value">-</div>
          </div>
          <div class="summary-item">
            <div class="label">Kern Ã˜</div>
            <div id="coreAvg" class="value">-</div>
          </div>
          <div class="summary-item">
            <div class="label">Erw. Ã˜</div>
            <div id="extAvg" class="value">-</div>
          </div>
        </div>
      </div>
    </div>

    <div id="cards" class="cards" aria-live="polite"></div>
  </main>

  <div id="emojiPicker" class="emoji-picker" style="display:none"></div>
  <div id="floatingMenu" class="menu-panel" style="display:none"></div>

</body>
<script>
  const toggleButton = document.getElementById('toggle-btn')
  const sidebar = document.getElementById('sidebar')

  function toggleSidebar() {
    sidebar.classList.toggle('close')
    toggleButton.classList.toggle('rotate')

    closeAllSubMenus()
  }

  function toggleSubMenu(button) {

    if (!button.nextElementSibling.classList.contains('show')) {
      closeAllSubMenus()
    }

    button.nextElementSibling.classList.toggle('show')
    button.classList.toggle('rotate')

    if (sidebar.classList.contains('close')) {
      sidebar.classList.toggle('close')
      toggleButton.classList.toggle('rotate')
    }
  }

  function closeAllSubMenus() {
    Array.from(sidebar.getElementsByClassName('show')).forEach(ul => {
      ul.classList.remove('show')
      ul.previousElementSibling.classList.remove('rotate')
    })
  }

  /* Main function */

  (function () {
    const STORAGE_KEY = 'subjects_v3';
    const SIDEBAR_KEY = 'sidebarCollapsed_v1';
    const cardsEl = document.getElementById('cards');
    const openAdd = document.getElementById('openAdd');
    const inlineAdd = document.getElementById('inlineAdd');
    const newSubjectName = document.getElementById('newSubjectName');
    const addSubjectBtn = document.getElementById('addSubjectBtn');
    const cancelAdd = document.getElementById('cancelAdd');
    // Global menu removed
    const emojiPicker = document.getElementById('emojiPicker');
    const floatingMenu = document.getElementById('floatingMenu');
    const statsToggle = document.getElementById('statsToggle');

    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const saveDiskBtn = document.getElementById('saveDiskBtn');
    const fileInput = document.getElementById('fileInput');

    // <-- safe reference to optional checkbox (may be missing in some pages)
    const markLowCheckbox = document.getElementById('markLowCheckbox');

    const EMOJIS = ['ðŸ“˜', 'ðŸ”¢', 'ðŸ“š', 'ðŸ§¬', 'âš—ï¸', 'ðŸ”­', 'ðŸŽ¨', 'ðŸŽµ', 'ðŸ’»', 'âš½ï¸', 'ðŸ§ª', 'ðŸ“ˆ', 'âœï¸', 'ðŸ§®', 'ðŸ§‘â€ðŸ”¬', 'ðŸ«', 'âš½', 'âš–ï¸', 'ðŸ³', 'ðŸ‡«ðŸ‡·', 'ðŸ‡®ðŸ‡¹', 'ðŸ‡©ðŸ‡ª', 'ðŸ‡¬ðŸ‡§', 'ðŸ‘¨â€ðŸ”§'];

    let subjects = load();
    let settings = loadSettings();
    let fileHandle = null; // optional File System Access handle

    renderSubjects(); updateSummary();

    const statsSubmenu = document.getElementById('statsSubmenu');
    if (statsToggle && statsSubmenu) {
      statsToggle.addEventListener('click', () => {
        const open = statsSubmenu.style.display !== 'flex';
        statsSubmenu.style.display = open ? 'flex' : 'none';
        statsSubmenu.setAttribute('aria-hidden', !open);
      });
    }

    // add subject (guarding existence)
    if (openAdd && inlineAdd && newSubjectName && cancelAdd && addSubjectBtn) {
      openAdd.addEventListener('click', () => { inlineAdd.style.display = 'inline-flex'; newSubjectName.focus(); });
      cancelAdd.addEventListener('click', () => { inlineAdd.style.display = 'none'; newSubjectName.value = ''; });
      addSubjectBtn.addEventListener('click', () => { const name = (newSubjectName.value || '').trim(); if (!name) return newSubjectName.focus(); addSubject(name); newSubjectName.value = ''; inlineAdd.style.display = 'none'; });
      newSubjectName.addEventListener('keydown', e => { if (e.key === 'Enter') addSubjectBtn.click(); if (e.key === 'Escape') cancelAdd.click(); });
    }

    // export / import handlers (guard DOM elements)
    if (exportBtn) exportBtn.addEventListener('click', () => exportData());
    if (importBtn && fileInput) importBtn.addEventListener('click', () => fileInput.click());
    if (fileInput) fileInput.addEventListener('change', (e) => { const f = e.target.files[0]; if (f) importDataFromFile(f); e.target.value = ''; });

    // save to disk using File System Access API if available
    if (saveDiskBtn) {
      saveDiskBtn.addEventListener('click', async () => {
        if ('showSaveFilePicker' in window) {
          try {
            const handle = await window.showSaveFilePicker({ suggestedName: 'subjects.json', types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }] });
            const writable = await handle.createWritable();
            await writable.write(JSON.stringify({ subjects, settings }, null, 2));
            await writable.close();
            alert('Daten in Datei gespeichert.');
          } catch (err) {
            // Wenn der Benutzer den Dialog abbricht, bekommt man oft ein AbortError â€” das ist kein "Fehler" im Sinne von App-Bug.
            if (err && err.name === 'AbortError') {
              // still ignore silently (no console.error)
              return;
            }
            console.error(err);
            alert('Speichern abgebrochen oder fehlgeschlagen.');
          }
        } else {
          // fallback: export as download
          exportData();
        }
      });
    }

    // Global menu logic removed

    // helpers: load/save
    function load() { try { const raw = localStorage.getItem(STORAGE_KEY); if (raw) return JSON.parse(raw); } catch (e) { } return demo(); }
    function save() { subjects.sort((a, b) => (a.order || 0) - (b.order || 0)); localStorage.setItem(STORAGE_KEY, JSON.stringify(subjects)); }
    function loadSettings() { try { const raw = localStorage.getItem('settings_v1'); if (raw) return JSON.parse(raw); } catch (e) { } return { markLow: false }; }
    function saveSettings() { localStorage.setItem('settings_v1', JSON.stringify(settings)); }

    function demo() { return [{ id: 's1', name: 'Mathe', icon: 'ðŸ”¢', type: 'core', order: 0, exams: [] }, { id: 's2', name: 'Deutsch', icon: 'ðŸ“š', type: 'core', order: 1, exams: [] }, { id: 's3', name: 'Musik', icon: 'ðŸŽµ', type: 'extension', order: 2, exams: [] }]; }

    function addSubject(name) { const s = { id: 's_' + Date.now() + Math.floor(Math.random() * 1000), name, icon: chooseIcon(name), type: 'extension', order: subjects.length, exams: [] }; subjects.unshift(s); subjects.forEach((s, i) => s.order = i); save(); renderSubjects(); updateSummary(); }
    function deleteSubject(id) { if (!confirm('Fach wirklich lÃ¶schen?')) return; subjects = subjects.filter(s => s.id !== id); subjects.forEach((s, i) => s.order = i); save(); renderSubjects(); updateSummary(); }
    function chooseIcon(name) { const n = name.toLowerCase(); if (n.includes('mat')) return 'ðŸ”¢'; if (n.includes('deut') || n.includes('lang')) return 'ðŸ“š'; if (n.includes('eng')) return 'ðŸ‡¬ðŸ‡§'; if (n.includes('bio')) return 'ðŸ§¬'; return 'ðŸ“˜'; }

    // export current data as subjects.json (download)
    function exportData() {
      try {
        const payload = { subjects, settings };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'subjects.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      } catch (err) { console.error('Export fehlgeschlagen', err); alert('Export fehlgeschlagen'); }
    }

    // import from a user-selected file (JSON)
    function importDataFromFile(file) {
      const reader = new FileReader(); reader.onload = (ev) => {
        try {
          const parsed = JSON.parse(ev.target.result);
          if (parsed.subjects) { subjects = parsed.subjects; }
          if (parsed.settings) {
            settings = parsed.settings;
            // Only touch DOM if the checkbox exists
            if (markLowCheckbox) markLowCheckbox.checked = !!settings.markLow;
            saveSettings();
          }
          // ensure orders
          subjects.forEach((s, i) => s.order = i);
          save(); renderSubjects(); updateSummary(); alert('Daten erfolgreich importiert.');
        } catch (err) { console.error('Import Fehler', err); alert('Datei konnte nicht gelesen werden. Stelle sicher, dass es eine gÃ¼ltige JSON-Datei ist.'); }
      };
      reader.onerror = () => { alert('Datei konnte nicht gelesen werden.'); };
      reader.readAsText(file);
    }

    // position a floating panel near an element rect, keeps on-screen
    function positionPanel(panel, rect) { const padding = 8; const w = panel.offsetWidth || 240; let left = rect.right + 6; let top = rect.top; if (left + w > window.innerWidth - padding) left = rect.left - w - 6; if (left < padding) left = padding; if (top + panel.offsetHeight > window.innerHeight - padding) top = window.innerHeight - panel.offsetHeight - padding; if (top < padding) top = padding; panel.style.left = left + 'px'; panel.style.top = top + 'px'; }

    // helper: bestimmt sinnvolle Dezimalstellen aus dem Schritt (z.B. 0.25 -> 2)
    function decimalsFromStep(step) {
      const s = String(step);
      if (s.indexOf('.') === -1) return 0;
      return s.split('.')[1].length;
    }

    // helper: sicheres Formatieren (vermeidet 4.6000000000000005)
    function formatNumber(value, decimals) {
      const d = (typeof decimals === 'number') ? decimals : 1;
      return parseFloat(Number(value).toFixed(d));
    }

    // sichere Runden-Funktion: rundet auf nearest step oder auf 1 Dezimalstelle (default)
    function roundToStep(value, step) {
      if (value === null || value === undefined || isNaN(value)) return value;
      const num = Number(value);
      if (!step || step === 'none') {
        return formatNumber(num, 1);
      }
      const s = parseFloat(step);
      if (isNaN(s) || s <= 0) {
        return formatNumber(num, 1);
      }
      const rounded = Math.round((num + Number.EPSILON) / s) * s;
      const decimals = decimalsFromStep(s);
      return formatNumber(rounded, decimals);
    }

    // render subjects and cards
    function renderSubjects() {
      cardsEl.innerHTML = '';
      subjects.sort((a, b) => (a.order || 0) - (b.order || 0));
      subjects.forEach(s => {
        const card = document.createElement('div'); card.className = 'card'; card.dataset.id = s.id; card.draggable = true;

        const header = document.createElement('div'); header.className = 'card-header';
        const title = document.createElement('div'); title.className = 'card-title';
        const iconBox = document.createElement('div'); iconBox.className = 'subject-icon'; iconBox.textContent = s.icon; iconBox.title = 'Icon Ã¤ndern';
        const nameEl = document.createElement('div'); nameEl.style.fontWeight = 900; nameEl.textContent = s.name;
        title.appendChild(iconBox); title.appendChild(nameEl);

        const actions = document.createElement('div'); actions.className = 'card-actions';
        const dotsBtn = document.createElement('button'); dotsBtn.className = 'icon-btn'; dotsBtn.textContent = 'â‹¯'; dotsBtn.title = 'Optionen';
        actions.appendChild(dotsBtn);

        header.appendChild(title); header.appendChild(actions);
        card.appendChild(header);

        // exams
        const examsEl = document.createElement('div'); examsEl.className = 'exams';
        if (s.exams && s.exams.length) {
          s.exams.forEach(ex => {
            const exEl = document.createElement('div'); exEl.className = 'exam'; exEl.dataset.examId = ex.id; // eindeutige Zuordnung fÃ¼r das Edit-Formular
            const meta = document.createElement('div'); meta.className = 'meta';
            const exTitle = document.createElement('div'); exTitle.style.fontWeight = 800; exTitle.textContent = ex.name;
            const exDesc = document.createElement('div'); exDesc.className = 'muted'; exDesc.style.fontSize = '13px'; exDesc.textContent = ex.desc || '';
            const exDate = document.createElement('div'); exDate.className = 'muted'; exDate.style.fontSize = '12px'; exDate.textContent = ex.date ? ('Datum: ' + ex.date) : '';
            meta.appendChild(exTitle); meta.appendChild(exDesc); meta.appendChild(exDate);

            const right = document.createElement('div'); right.style.display = 'flex'; right.style.flexDirection = 'column'; right.style.alignItems = 'flex-end'; right.style.gap = '8px';

            // calculated note
            let calcNote = null;
            if (ex.maxPoints && ex.achievedPoints) { const max = parseFloat(ex.maxPoints) || 0; const ach = parseFloat(ex.achievedPoints) || 0; if (max > 0) { calcNote = 1 + (ach / max) * 5; } }
            // apply rounding to calculated note (uses the shared roundToStep helper)
            const calcRounded = calcNote !== null ? roundToStep(calcNote, ex.round) : null

            const grade = document.createElement('div'); grade.className = 'grade'; grade.textContent = ex.grade || '-';
            // color low if setting enabled and grade <4.0
            function markLowIfNeeded(el, val) { if (settings.markLow && val !== null && !isNaN(val) && parseFloat(val) < 4.0) { el.classList.add('low'); } else el.classList.remove('low'); }
            markLowIfNeeded(grade, parseFloat(ex.grade));

            if (calcRounded !== null) { const calcSmall = document.createElement('div'); calcSmall.style.fontSize = '12px'; calcSmall.className = 'muted'; calcSmall.textContent = 'Berechnet: ' + calcRounded; markLowIfNeeded(calcSmall, calcRounded); right.appendChild(calcSmall); }
            right.appendChild(grade);

            const exActions = document.createElement('div'); exActions.style.display = 'flex'; exActions.style.gap = '6px';
            const editExamBtn = document.createElement('button'); editExamBtn.className = 'icon-btn'; editExamBtn.title = 'Bearbeiten'; editExamBtn.textContent = 'âœï¸';
            const delExamBtn = document.createElement('button'); delExamBtn.className = 'icon-btn'; delExamBtn.title = 'LÃ¶schen'; delExamBtn.textContent = 'ðŸ—‘ï¸';
            exActions.appendChild(editExamBtn); exActions.appendChild(delExamBtn);
            right.appendChild(exActions);

            exEl.appendChild(meta); exEl.appendChild(right);
            examsEl.appendChild(exEl);

            // warning if mismatch (now exact mismatch between entered and calculated rounded)
            if (calcRounded !== null && ex.grade) {
              const entered = parseFloat(ex.grade);
              if (isFinite(entered) && Math.abs(entered - calcRounded) > 0.0001) {
                // only show warning if user didn't dismiss it
                if (!ex.warnDismissed) {
                  const warn = document.createElement('div');
                  warn.className = 'warn-box';
                  const txt = document.createElement('div');
                  txt.className = 'warn-text';
                  txt.textContent = 'Warnung: Die berechnete Note (' + calcRounded + ') stimmt nicht mit der eingetragenen Note (' + entered + ') Ã¼berein.';
                  const closeBtn = document.createElement('button');
                  closeBtn.className = 'warn-close';
                  closeBtn.title = 'Warnung ausblenden';
                  closeBtn.textContent = 'âœ–';
                  closeBtn.addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    // persist dismissal so it won't reappear until exam is edited/updated
                    ex.warnDismissed = true;
                    save();
                    renderSubjects();
                  });
                  warn.appendChild(txt);
                  warn.appendChild(closeBtn);
                  examsEl.appendChild(warn);
                }
              }
            }

            // listeners
            editExamBtn.addEventListener('click', () => openExamForm(card, s.id, ex));
            delExamBtn.addEventListener('click', () => { if (confirm('PrÃ¼fung wirklich lÃ¶schen?')) { deleteExam(s.id, ex.id); } });

          });
        } else { const none = document.createElement('div'); none.className = 'muted'; none.textContent = 'Keine PrÃ¼fungen'; examsEl.appendChild(none); }

        card.appendChild(examsEl);

        // separator bar above footer
        const sep = document.createElement('div'); sep.className = 'card-sep'; card.appendChild(sep);

        // footer with add + sorting and avg
        const footer = document.createElement('div'); footer.className = 'card-footer';
        const left = document.createElement('div'); left.style.display = 'flex'; left.style.alignItems = 'center'; left.style.gap = '8px';
        const plusBtn = document.createElement('button'); plusBtn.className = 'btn'; plusBtn.textContent = 'ï¼‹'; plusBtn.title = 'HinzufÃ¼gen'; left.appendChild(plusBtn);
        const sortSelect = document.createElement('select');['Datum â†“', 'Datum â†‘', 'Name A â†’ Z', 'Name Z â†’ A', 'Note â†“', 'Note â†‘'].forEach(opt => { const o = document.createElement('option'); o.value = o.textContent = opt; sortSelect.appendChild(o); }); left.appendChild(sortSelect);

        const avg = document.createElement('div'); avg.className = 'avg'; const subjAvg = computeSubjectAvg(s); avg.textContent = 'Ã˜: ' + (subjAvg === null ? '-' : subjAvg); if (settings.markLow && subjAvg !== null && subjAvg < 4.0) avg.classList.add('low'); else avg.classList.remove('low');

        footer.appendChild(left); footer.appendChild(avg);
        card.appendChild(footer);

        cardsEl.appendChild(card);

        // interactions: icon click -> emoji picker
        iconBox.addEventListener('click', (ev) => { ev.stopPropagation(); showEmojiPicker(ev.clientX, ev.clientY, (emoji) => { s.icon = emoji; save(); renderSubjects(); }); });

        // name edit
        nameEl.addEventListener('click', () => { const input = document.createElement('input'); input.value = s.name; input.style.fontWeight = 900; input.style.fontSize = '15px'; title.replaceChild(input, nameEl); input.focus(); input.select(); function finish() { const v = (input.value || '').trim(); if (v) { s.name = v; save(); renderSubjects(); } else renderSubjects(); } input.addEventListener('keydown', e => { if (e.key === 'Enter') finish(); if (e.key === 'Escape') renderSubjects(); }); input.addEventListener('blur', finish); });

        // dots menu positioning
        dotsBtn.addEventListener('click', (ev) => { ev.stopPropagation(); floatingMenu.innerHTML = ''; const btnRect = ev.target.getBoundingClientRect(); const menu = document.createElement('div'); menu.style.padding = '6px'; const t1 = document.createElement('button'); t1.textContent = s.type === 'core' ? 'Als Erweiterung markieren' : 'Als Kernfach markieren'; t1.addEventListener('click', () => { s.type = s.type === 'core' ? 'extension' : 'core'; save(); renderSubjects(); floatingMenu.style.display = 'none'; }); const t2 = document.createElement('button'); t2.textContent = 'Fach lÃ¶schen'; t2.addEventListener('click', () => { if (confirm('Fach wirklich lÃ¶schen?')) { deleteSubject(s.id); floatingMenu.style.display = 'none'; } }); menu.appendChild(t1); menu.appendChild(t2); floatingMenu.appendChild(menu); positionPanel(floatingMenu, btnRect); floatingMenu.style.display = 'block'; });

        // plus add exam
        plusBtn.addEventListener('click', (ev) => { ev.stopPropagation(); openExamForm(card, s.id); });

        // sort select
        sortSelect.addEventListener('change', () => { const val = sortSelect.value; sortExamsForSubject(s.id, val); save(); renderSubjects(); });

        // drag handlers (card-level)
        card.addEventListener('dragstart', (e) => { card.classList.add('dragging'); e.dataTransfer.setData('text/plain', s.id); });
        card.addEventListener('dragend', () => { card.classList.remove('dragging'); Array.from(cardsEl.children).forEach((c, i) => { const id = c.dataset.id; const subj = subjects.find(x => x.id === id); if (subj) subj.order = i; }); save(); renderSubjects(); });

      });

      // helper: bestimmt sinnvolle Dezimalstellen aus dem Schritt (z.B. 0.25 -> 2)
      function decimalsFromStep(step) {
        const s = String(step);
        if (s.indexOf('.') === -1) return 0;
        return s.split('.')[1].length;
      }

      // helper: sicheres Formatieren (vermeidet 4.6000000000000005)
      function formatNumber(value, decimals) {
        // falls decimals nicht angegeben: behandle als 1 Dezimalstelle (wie vorher)
        const d = (typeof decimals === 'number') ? decimals : 1;
        // toFixed sorgt fÃ¼r stabile Darstellung, parseFloat entfernt unnÃ¶tige Nullen
        return parseFloat(Number(value).toFixed(d));
      }

      // sichere Runden-Funktion: rundet auf nearest step oder auf 1 Dezimalstelle (default)
      function roundToStep(value, step) {
        if (value === null || value === undefined || isNaN(value)) return value;
        const num = Number(value);
        // default: runde auf 1 Dezimalstelle (wie vorher Math.round(value*10)/10)
        if (!step || step === 'none') {
          return formatNumber(num, 1);
        }
        const s = parseFloat(step);
        if (isNaN(s) || s <= 0) {
          return formatNumber(num, 1);
        }
        // Runde auf nÃ¤chstes Vielfaches von s
        // Addiere eine kleine EPSILON vor dem Runden um GrenzfÃ¤lle zu stabilisieren
        const rounded = Math.round((num + Number.EPSILON) / s) * s;
        // Bestimme sinnvolle Dezimalstellen aus dem Schritt (z.B. 0.25 -> 2)
        const decimals = decimalsFromStep(s);
        return formatNumber(rounded, decimals);
      }
    }

    // allow dragover on container to place dragged card
    cardsEl.addEventListener('dragover', e => { e.preventDefault(); const dragging = document.querySelector('.card.dragging'); const after = getDragAfterElement(cardsEl, e.clientY); if (!dragging) return; if (after == null) cardsEl.appendChild(dragging); else cardsEl.insertBefore(dragging, after); });

    cardsEl.addEventListener('drop', e => { e.preventDefault(); Array.from(cardsEl.children).forEach((c, i) => { const id = c.dataset.id; const subj = subjects.find(x => x.id === id); if (subj) subj.order = i; }); save(); renderSubjects(); });

    function getDragAfterElement(container, y) { const draggableElements = [...container.querySelectorAll('.card:not(.dragging)')]; return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) return { offset: offset, element: child }; return closest; }, { offset: Number.NEGATIVE_INFINITY }).element || null; }

    // exam form: add/edit
    function openExamForm(card, subjectId, exam) {
      // Wenn wir eine bestehende PrÃ¼fung bearbeiten: Formular direkt unterhalb der PrÃ¼fung anfÃ¼gen
      let container = null;
      if (exam) {
        // finde das DOM-Element der PrÃ¼fung
        const existingExEl = card.querySelector('.exam[data-exam-id="' + exam.id + '"]');
        if (existingExEl) {
          // Falls schon ein Formular existiert, entferne es zuerst
          const prevForm = card.querySelector('.exam-form');
          if (prevForm) prevForm.remove();
          container = document.createElement('div'); container.className = 'exam-form';
          existingExEl.parentNode.insertBefore(container, existingExEl.nextSibling);
        } else {
          // Fallback: append am Ende der Karte
          container = card.querySelector('.exam-form') || document.createElement('div');
          container.className = 'exam-form';
          if (!card.contains(container)) card.appendChild(container);
        }
      } else {
        // neue PrÃ¼fung: Formular oben in der Karte (oder wiederverwenden)
        container = card.querySelector('.exam-form') || document.createElement('div');
        container.className = 'exam-form';
        if (!card.contains(container)) card.appendChild(container);
      }

      container.innerHTML = ''; container.style.display = 'flex';

      const nameInput = document.createElement('input'); nameInput.placeholder = 'Name der PrÃ¼fung'; nameInput.value = exam?.name || '';
      const descInput = document.createElement('textarea'); descInput.placeholder = 'Beschreibung (optional)'; descInput.rows = 2; descInput.value = exam?.desc || '';
      const dateInput = document.createElement('input'); dateInput.type = 'date'; dateInput.value = exam?.date || '';
      const row = document.createElement('div'); row.className = 'row';
      const maxInput = document.createElement('input'); maxInput.placeholder = 'Max Punkte'; maxInput.type = 'number'; maxInput.min = '0'; maxInput.step = '0.1'; maxInput.style.flex = '1'; maxInput.value = exam?.maxPoints || '';
      const achInput = document.createElement('input'); achInput.placeholder = 'Erreichte Punkte'; achInput.type = 'number'; achInput.min = '0'; achInput.step = '0.1'; achInput.style.flex = '1'; achInput.value = exam?.achievedPoints || '';
      row.appendChild(maxInput); row.appendChild(achInput);
      const roundSelect = document.createElement('select');['none', '0.1', '0.25', '0.5', '1'].forEach(opt => { const o = document.createElement('option'); o.value = opt; o.textContent = opt === 'none' ? 'Keine' : opt; if (exam && exam.round === opt) o.selected = true; roundSelect.appendChild(o); });
      const multSelect = document.createElement('select');[['0.5', '0.5x'], ['1', '1x'], ['2', '2x']].forEach(pair => { const o = document.createElement('option'); o.value = pair[0]; o.textContent = pair[1]; if (exam && String(exam.multiplier) === pair[0]) o.selected = true; multSelect.appendChild(o); });
      const gradeInput = document.createElement('input'); gradeInput.placeholder = 'Note (z.B. 5.0)'; gradeInput.type = 'text'; gradeInput.value = exam?.grade || '';
      const buttons = document.createElement('div'); buttons.style.display = 'flex'; buttons.style.gap = '8px'; const saveBtn = document.createElement('button'); saveBtn.className = 'btn accent'; saveBtn.textContent = exam ? 'Speichern' : 'PrÃ¼fung hinzufÃ¼gen'; const cancelBtn = document.createElement('button'); cancelBtn.className = 'btn'; cancelBtn.textContent = 'Abbrechen'; buttons.appendChild(saveBtn); buttons.appendChild(cancelBtn);

      container.appendChild(nameInput); container.appendChild(descInput); container.appendChild(dateInput); container.appendChild(row);
      const row2 = document.createElement('div'); row2.className = 'row'; row2.appendChild(gradeInput); row2.appendChild(roundSelect); row2.appendChild(multSelect); container.appendChild(row2);
      container.appendChild(buttons);

      nameInput.focus();

      saveBtn.addEventListener('click', () => {
        const name = (nameInput.value || '').trim(); if (!name) return nameInput.focus(); const desc = (descInput.value || '').trim(); const date = dateInput.value || ''; const maxPoints = maxInput.value || ''; const achievedPoints = achInput.value || ''; const round = roundSelect.value || 'none'; const multiplier = parseFloat(multSelect.value) || 1; const grade = (gradeInput.value || '').trim(); const data = { name, desc, date, maxPoints, achievedPoints, round, multiplier, grade };
        if (exam) { editExam(subjectId, exam.id, data); } else { addExamToSubject(subjectId, data); }
        // nach speichern Formular entfernen (oder ausblenden)
        container.style.display = 'none';
      });
      cancelBtn.addEventListener('click', () => { container.style.display = 'none'; });
    }

    function addExamToSubject(subjectId, exam) { const s = subjects.find(x => x.id === subjectId); if (!s) return; exam.id = 'e_' + Date.now() + Math.floor(Math.random() * 1000); exam.multiplier = exam.multiplier || 1; exam.warnDismissed = false; s.exams.unshift(exam); save(); renderSubjects(); updateSummary(); }
    function editExam(subjectId, examId, data) {
      const s = subjects.find(x => x.id === subjectId); if (!s) return; const e = s.exams.find(x => x.id === examId); if (!e) return; Object.assign(e, data); // reset dismissal so a new/changed mismatch can reappear
      e.warnDismissed = false;
      save(); renderSubjects(); updateSummary();
    }
    function deleteExam(subjectId, examId) { const s = subjects.find(x => x.id === subjectId); if (!s) return; s.exams = s.exams.filter(x => x.id !== examId); save(); renderSubjects(); updateSummary(); }

    function computeSubjectAvg(subject) {
      if (!subject.exams || subject.exams.length === 0) return null; let sum = 0, weightSum = 0; subject.exams.forEach(ex => { const g = parseFloat(ex.grade); if (!isNaN(g)) { const mult = parseFloat(ex.multiplier) || 1; sum += g * mult; weightSum += mult; } }); if (weightSum === 0) return null; let avg = sum / weightSum;
      return formatNumber(avg, 1);
    }

    function updateSummary() { const core = subjects.filter(s => s.type === 'core'); const ext = subjects.filter(s => s.type === 'extension'); const coreAvg = averageOfList(core); const extAvg = averageOfList(ext); const totalAvg = averageOfList(subjects); document.getElementById('totalAvg').textContent = totalAvg === null ? '-' : totalAvg; document.getElementById('coreAvg').textContent = coreAvg === null ? '-' : coreAvg; document.getElementById('extAvg').textContent = extAvg === null ? '-' : extAvg; }
    function averageOfList(list) {
      if (!list.length) return null; let sum = 0, count = 0; list.forEach(s => { const a = computeSubjectAvg(s); if (a !== null) { sum += a; count++; } }); if (count === 0) return null; return formatNumber(sum / count, 1);
    }

    function sortExamsForSubject(subjectId, mode) {
      const s = subjects.find(x => x.id === subjectId); if (!s) return; if (!s.exams) return; switch (mode) { case 'Datumâ†“': s.exams.sort((a, b) => (b.date || '').localeCompare(a.date || '')); break; case 'Datumâ†‘': s.exams.sort((a, b) => (a.date || '').localeCompare(b.date || '')); break; case 'Name Aâ†’Z': s.exams.sort((a, b) => (a.name || '').localeCompare(b.name || '')); break; case 'Name Zâ†’A': s.exams.sort((a, b) => (b.name || '').localeCompare(a.name || '')); break; case 'Note â†“': s.exams.sort((a, b) => (parseFloat(b.grade) || 0) - (parseFloat(a.grade) || 0)); break; case 'Note â†‘': s.exams.sort((a, b) => (parseFloat(a.grade) || 0) - (parseFloat(b.grade) || 0)); break; }
    }

    // emoji picker
    function showEmojiPicker(x, y, cb) {
      emojiPicker.innerHTML = ''; EMOJIS.forEach(em => { const b = document.createElement('button'); b.type = 'button'; b.textContent = em; b.addEventListener('click', () => { cb(em); hideEmojiPicker(); }); emojiPicker.appendChild(b); }); emojiPicker.style.display = 'grid'; // position
      const padding = 8; const w = emojiPicker.offsetWidth || 220; let left = x; let top = y; if (left + w > window.innerWidth - padding) left = window.innerWidth - w - padding; if (left < padding) left = padding; if (top + emojiPicker.offsetHeight > window.innerHeight - padding) top = window.innerHeight - emojiPicker.offsetHeight - padding; if (top < padding) top = padding; emojiPicker.style.left = left + 'px'; emojiPicker.style.top = top + 'px';
    }
    function hideEmojiPicker() { emojiPicker.style.display = 'none'; }

    function positionPanel(panel, rect) { // rect can be DOMRect or element
      let r = rect; if (rect instanceof DOMRect === false && rect.getBoundingClientRect) r = rect.getBoundingClientRect(); const padding = 8; const w = panel.offsetWidth || 240; let left = r.right + 6; let top = r.top; if (left + w > window.innerWidth - padding) left = r.left - w - 6; if (left < padding) left = padding; if (top + panel.offsetHeight > window.innerHeight - padding) top = window.innerHeight - panel.offsetHeight - padding; if (top < padding) top = padding; panel.style.left = left + 'px'; panel.style.top = top + 'px';
    }

    // click outside closes handled above

    // helper: find subject
    function findSubject(id) { return subjects.find(s => s.id === id); }

    // helper: choose icon
    function chooseIcon(name) { const n = name.toLowerCase(); if (n.includes('mat')) return 'ðŸ”¢'; if (n.includes('deut') || n.includes('lang')) return 'ðŸ“š'; if (n.includes('eng')) return 'ðŸ‡¬ðŸ‡§'; if (n.includes('bio')) return 'ðŸ§¬'; return 'ðŸ“˜'; }
    // --- Touch-friendly reordering: Up/Down buttons fÃ¼r iPad/Touch ---
    function attachMoveHandlers() {
      const cards = Array.from(cardsEl.querySelectorAll('.card'));
      cards.forEach((card, idx) => {
        const header = card.querySelector('.card-header'); if (!header) return;
        // vermeiden doppelte Buttons
        if (header.querySelector('.move-up')) return;
        const up = document.createElement('button'); up.className = 'icon-btn move-up'; up.title = 'Nach oben verschieben'; up.textContent = 'â–²';
        const down = document.createElement('button'); down.className = 'icon-btn move-down'; down.title = 'Nach unten verschieben'; down.textContent = 'â–¼';
        up.addEventListener('click', (e) => { e.stopPropagation(); const id = card.dataset.id; const i = subjects.findIndex(s => s.id === id); if (i > 0) { [subjects[i - 1], subjects[i]] = [subjects[i], subjects[i - 1]]; subjects.forEach((s, j) => s.order = j); save(); renderSubjects(); updateSummary(); } });
        down.addEventListener('click', (e) => { e.stopPropagation(); const id = card.dataset.id; const i = subjects.findIndex(s => s.id === id); if (i < subjects.length - 1) { [subjects[i + 1], subjects[i]] = [subjects[i], subjects[i + 1]]; subjects.forEach((s, j) => s.order = j); save(); renderSubjects(); updateSummary(); } });
        // Buttons in actions (left side)
        const actions = header.querySelector('.card-actions'); if (actions) { actions.insertBefore(up, actions.firstChild); actions.insertBefore(down, actions.firstChild); }
      });
    }

    // Beobachter, der bei DOM-Ã„nderungen die Move-Buttons neu anlegt
    const mo = new MutationObserver(() => { attachMoveHandlers(); });
    mo.observe(cardsEl, { childList: true, subtree: true });

    // einmal initial
    attachMoveHandlers();

    const menus = [];
    if (emojiPicker) menus.push(emojiPicker);
    if (floatingMenu) menus.push(floatingMenu);

    // Klick ausserhalb schliesst alle Menus
    document.addEventListener('click', (e) => {
      // wenn Klick innerhalb eines Menus oder auf einem Toggle war, nichts tun
      if (e.target.closest('.emoji-picker') ||
        e.target.closest('.menu-panel') ||
        e.target.closest('[data-menu-toggle]') ||
        e.target.closest('.card-actions') // optional: Aktionen/Buttons ignorieren
      ) {
        return;
      }

      // sonst alle Menus schliessen (sicherheitscheck: menu kann undefined sein)
      menus.forEach(m => { if (m) m.style.display = 'none'; });
    });

    // Escape-Taste schliesst ebenfalls
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        menus.forEach(m => { if (m) m.style.display = 'none'; });
      }
    });

  })();
</script>

</html>